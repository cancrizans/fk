 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 
 <html lang="en"> 
 <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Flesh Kernel</title> 
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>

    <div id="page">
        <div id="content">

            <div id="menu">
                <div class="menuentry"><a href="?">Home</a></div>
                <div class="menuentry"><a href="?" id="latestlink">Latest</a></div>
                <div class="menuentry"><a href="https://www.instagram.com/cancrizans.canon/">Art</a></div>
                <div class="menuentry">Cast</div>
                <div class="menuentry"><a href="https://tscomix.fandom.com/wiki/Flesh_Kernel">Wiki</a></div>
            </div>

            <img src="img/banner.gif" class="titlebanner">

            <div id="homepage" class="hidden">
                <div id="pitch">Earth was invaded by aliens... 300 years ago. The dead God of Rebirth exploits a shared subconscious channel to contact a human, an alien, and a human-alien hybrid to retrieve an object of cosmic potential known as the <span class="emphasis">Flesh Kernel</span>.</div>

                <div class="paragraph">Flesh Kernel is a webcomic by <a href="https://cancrizans.github.io/">cancrizans</a>. You can choose from the archives here or just scroll further down to start reading from the beginning.</div>
                
                <div id="archive">
                    <a name="archive"></a>
                    <template id="chapterarchive">
                        <div class="chapterarchive">
                            <img class="chapterpic">
                            <div class="chapterarchiveside">
                                <div class="chapterarchivetitle"></div>
                                <div class="chapterarchivelinks"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="separator"></div>


            </div>


            <div id="resumereading">
                <div class="resumetext"></div>

            </div>

            <noscript>
                <div id="noscript">
                    Error: your browser can't do javascript or you have it disabled. I can't show you my comic without it!
                </div>
            </noscript>

            <div id="comic">

                <template id="entrytemplate">
                    <div class="entry">
                        <div class="entryimgcontainer"></div>

                        <div class="entrylabel">
                            <div class="entrylabeltext"></div>

                        </div>
                        <div class="entryinfo">
                            <div class="entryinfopanel">
                                <div class="entrytitle"></div>
                                <div class="permalinkrow">
                                    <div class="permalink"></div>
                                    <img src="img/clipboard.svg" class="permalinkicon copyclipboard">
                                    <img src="img/check.svg" class="permalinkicon copyclipboardcheck hidden">
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <template id="breathertemplate">
                    <div class="entry">
                        <div class="gonextpage"><div class="gonexttext">Continue to </div><div class="nextpagetitle"></div></div>
                    </div>

                </template>

                <template id="seeyatemplate">
                    <div class="seeya">Mark the date: the next episode will be up next Friday!</div>
                </template>

                <template id="chapterstarttemplate">
                    <div class="entry">
                        <div class="chapterstarttitle">
                        </div>
                        <div class="chapterdate"></div>
                    </div>
                </template>

            </div>


            <div id="loadmorecontainer">
                <div id="loadmorebutton">
                    <img src="img/arrow-down.svg">
                    <div id="loadmoretext">Load more comics</div>
                </div>
            </div>

        </div>
    </div>

    <script type="text/javascript">

        var queryParams = (new URL(document.location)).searchParams;
        var wantedComic = queryParams.get('c');

        var baseURL = window.location.href.split('?')[0];




        $.ajaxSetup({
            beforeSend: function(xhr){
              if (xhr.overrideMimeType)
                xhr.overrideMimeType("application/json");
        },
        error:function() { alert("error");  }
    });



        var webcomic;

        $().ready(function(){

            $.getJSON( "fleshkernel.json", function( data ) {
                webcomic = data;
                onLoadWebcomic();
            });
        });


        function onLoadWebcomic(){

            var comicDiv = $("#comic");


            //find desired comic by query
            var wasFound = false;

            var loadedIndex = 0;
            if(wantedComic !=null){
                for(var wantedIndex = 1; wantedIndex<webcomic.entries.length; wantedIndex++){
                    if(webcomic.entries[wantedIndex].code == wantedComic){
                        loadedIndex = wantedIndex;
                        wasFound = true;
                        break;
                    }
                }
            }

            if(wasFound){

                //find previous comic
                var prev = null;
                for(var i = loadedIndex-1; i>=0; i--){
                    if(isComic(webcomic.entries[i])){
                        prev = webcomic.entries[i];
                        break;
                    }
                }

                var extraString = "";
                if(prev != null){
                    extraString = `<a href="?c=${prev.code}">back to ${prev.title}</a> or `;
                }

                $(".resumetext").html(`You are reading starting from "${webcomic.entries[loadedIndex].title}". Go ${extraString}<a href="?">back to the archives</a>.`)
            }
            else
            {
                $("#resumereading").remove();
                //home page
                $(".titlebanner").addClass("hidden");
                $("#homepage").removeClass("hidden");

                var chapterTemplate = $("#homepage").find("#chapterarchive").html().trim();
                var archiveDiv = $("#archive");
                var chapDiv;
                var chapLinksDiv;

                var flipChap = false;
                var chapNum = 1;

                for(var e of webcomic.entries){
                    if(e.type=="chapter"){
                        var roman = ["0","I","II","III","IV","V","VI","VII","VIII","IX","X"][chapNum]; 

                        chapDiv = $(chapterTemplate);
                        chapDiv.find(".chapterarchivetitle").text(roman+" "+e.title);
                        chapDiv.find(".chapterpic").attr("src","pic/"+e.img);
                        chapDiv.appendTo(archiveDiv);
                        chapLinksDiv = chapDiv.find(".chapterarchivelinks");


                        if(flipChap){
                            chapDiv.children().each(function(i,c){chapDiv.prepend(c)});
                        }
                        flipChap = !flipChap;

                        chapNum++;
                    }
                    else if (isComic(e)){
                        chapLinksDiv.append(`<a href="?c=${e.code}">${e.code}</a> `);
                    }
                }


            }


            //find latest comic
            var lastCode = "";
            for(var i = webcomic.entries.length-1; i>=0; i--){
                if(!("type" in webcomic.entries[i])){
                    lastCode = webcomic.entries[i].code;
                    break;
                }

            }
            
            $("#latestlink").attr("href",`?c=${lastCode}`);


            var subImageIndex = 0;

            var entryTemplate = $("#entrytemplate").html().trim();
            var breatherTemplate = $("#breathertemplate").html().trim();
            var chapterStartTemplate = $("#chapterstarttemplate").html().trim();

            var entryData;
            var entryDiv;
            var entryImgContainer;

            var stopLoad = false;

            function stopLoading(){

                stopLoad = true;

                $("#loadmorecontainer").addClass("hidden");
            }

            function isComic(entry){
                return !('type' in entry);
            }

            function nextComic(index){

                for(var i = index+1; i<webcomic.entries.length;i++)
                {
                    if(isComic(webcomic.entries[i]))
                        return i;
                }

                return null;
            }

            function loadMoreContent(){
                if(stopLoad)
                    return false;



                if(loadedIndex < webcomic.entries.length){

                    if(subImageIndex == 0) 
                    {
                        entryData = webcomic.entries[loadedIndex];

                        if(isComic(entryData)) 
                        {
                            entryDiv = $(entryTemplate);
                            entryImgContainer = entryDiv.find(".entryimgcontainer");
                            var entryInfo = entryDiv.find(".entryinfo");
                            var entryButton = entryDiv.find(".entrylabel");


                            entryButton.click(
                                              function() 
                                              {
                                                if (entryInfo.css("max-height") === "0px") 
                                                  entryInfo.css("max-height", entryInfo[0].scrollHeight +"px");
                                              else 
                                                  entryInfo.css("max-height", "0px");
                                          });

                            entryDiv.find(".entrylabeltext").text(entryData.code);

                            entryDiv.find(".entrytitle").text(entryData.title);


                            var permalink = baseURL + "?c=" + entryData.code;
                            entryInfo.find(".permalink").text(permalink);
                            var check = entryInfo.find(".copyclipboardcheck");
                            entryInfo.find(".copyclipboard").click(function()
                            {
                                navigator.clipboard.writeText(permalink).then( function()
                                {
                                    check.removeClass("hidden");
                                }
                                );
                            }
                            );

                            entryDiv.appendTo(comicDiv);
                        }
                        else if(entryData.type == "breather"){
                            stopLoading();
                            entryDiv = $(breatherTemplate);

                            var nextInd = nextComic(loadedIndex);

                            if(nextInd == null)
                                return false;

                            var next = webcomic.entries[nextInd];

                            entryDiv.find(".nextpagetitle").text(next.title);
                            entryDiv.appendTo(comicDiv);
                            entryDiv.click(function()
                            {
                                window.location = baseURL + '?c=' + next.code;
                            }
                            );

                            return false;
                        }
                        else if(entryData.type == "chapter"){
                            
                            entryDiv = $(chapterStartTemplate);
                            entryDiv.find(".chapterstarttitle").text(entryData.title);
                            entryDiv.find(".chapterdate").text(entryData.date);
                            entryDiv.appendTo(comicDiv);
                            

                        }
                        else{
                            console.log(entryData);
                            return true;
                        }
                    }

                    //if spilled over post length, reset to start of next and re-call function
                    if( (!isComic(entryData) || subImageIndex>= entryData.img.length)  ){

                        subImageIndex = 0;
                        loadedIndex += 1;

                        return loadMoreContent();
                    }

                    
                    //guaranteed within post length
                    
                    subImg = entryData.img[subImageIndex];
                    var img = $('<img class="comicpic loading">');
                    var url = webcomic.imgpath + entryData.prefix + subImg;



                    img.attr('src',url);

                    img.imagesLoaded().always(function(instance){
                        img.removeClass("loading");
                    });

                    img.appendTo(entryImgContainer);

                    subImageIndex += 1;   

                    return true;
                }
                else
                {
                    //end of comic
                    $($("#seeyatemplate").html().trim()).appendTo(comicDiv);

                    stopLoading();

                    return false;
                }
            }


            while($("#page").height() < $(window).height() + 200) {
                loadMoreContent();
            }



            function checkOnScroll(){
                    if ($(window).scrollTop() >= $("#page").innerHeight() - $(window).height() - 200)
                               {
                                 loadMoreContent();
                             }
            }

            $(window).scroll(checkOnScroll);

            $("body").bind("touchmove",checkOnScroll);


            $("#loadmorebutton").click( loadMoreContent);
        };






    </script>

</body> 
</html>
