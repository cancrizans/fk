 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 
 <html lang="en"> 
 <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Flesh Kernel</title> 
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <div id="page">
        <div id="content">

            <div id="comic">

                <template id="entrytemplate">
                    <div class="entry">
                        <div class="entryimgcontainer"></div>

                        <div class="entrylabel">
                            <div class="entrylabeltext"></div>

                        </div>
                        <div class="entryinfo">
                            <div class="entrytitle"></div>
                        </div>
                    </div>
                </template>

            </div>

        </div>
    </div>

    <script type="text/javascript">

        var queryParams = (new URL(document.location)).searchParams;
        var wantedComic = queryParams.get('c');




        $.ajaxSetup({
            beforeSend: function(xhr){
              if (xhr.overrideMimeType)
                xhr.overrideMimeType("application/json");
        },
        error:function() { alert("error");  }
    });



        var webcomic;

        $().ready(function(){

            $.getJSON( "fleshkernel.json", function( data ) {
                webcomic = data;
                onLoadWebcomic();
            });
        });


        function onLoadWebcomic(){

            var comicDiv = $("#comic");


            var loadedIndex = 0;
            if(wantedComic !=null){
                for(var wantedIndex = 0; wantedIndex<webcomic.entries.length; wantedIndex++){
                    if(webcomic.entries[wantedIndex].code == wantedComic){
                        loadedIndex = wantedIndex;
                    }
                }
            }

            var subImageIndex = 0;

            var entryTemplate = $("#entrytemplate").html().trim();
            

            var entryData;
            var entryDiv;
            var entryImgContainer;

            function loadMoreContent(){



                if(loadedIndex < webcomic.entries.length){

                    if(subImageIndex == 0) // new entry
                    {
                        entryData = webcomic.entries[loadedIndex];

                        entryDiv = $(entryTemplate);
                        entryImgContainer = entryDiv.find(".entryimgcontainer");
                        var entryInfo = entryDiv.find(".entryinfo");
                        var entryButton = entryDiv.find(".entrylabel");

                        entryButton.click(
                            function() {
                                console.log(entryInfo[0].scrollHeight);
                                if (entryInfo.css("max-height") === "0px") 
                                  entryInfo.css("max-height", entryInfo[0].scrollHeight +"px");
                                else 
                                  entryInfo.css("max-height", "0px");
                          }
                          );

                        //populate entry
                        entryDiv.find(".entrylabeltext").text(entryData.code);
                        
                        entryDiv.find(".entrytitle").text(entryData.title);

                        entryDiv.appendTo(comicDiv);

                    }

                    //if spilled over post length, reset to start of next and re-call function
                    if(subImageIndex>= entryData.img.length){
                        subImageIndex = 0;
                        loadedIndex += 1;

                        return loadMoreContent();
                    }

                    
                    //guaranteed within post length
                    
                    subImg = entryData.img[subImageIndex];
                    var img = $('<img class="comicpic loading">');
                    var url = webcomic.imgpath + entryData.prefix + subImg;



                    img.attr('src',url);
                    img.appendTo(entryImgContainer);

                    subImageIndex += 1;   

                    return true;
                }
                else
                    return false;
            }


            while($("#page").height() < $(window).height() + 200) {
                loadMoreContent();
            }

            $(window).scroll(function () { 
               if ($(window).scrollTop() >= $("#page").height() - $(window).height() - 200) {
                 loadMoreContent();
             }
         });

        };




    </script>

</body> 
</html>
